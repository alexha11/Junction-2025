OPTIMIZER AGENT - COMPONENT TREE
================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        OPTIMIZATION AGENT SYSTEM                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“ optimizer_agent/
â”‚
â”œâ”€â”€ ğŸ”§ CORE COMPONENTS
â”‚   â”‚
â”‚   â”œâ”€â”€ main.py (434 lines)
â”‚   â”‚   â””â”€â”€ OptimizationAgent
â”‚   â”‚       â”œâ”€â”€ BaseMCPAgent (inheritance)
â”‚   â”‚       â”œâ”€â”€ MPCOptimizer (composition)
â”‚   â”‚       â”œâ”€â”€ LLMExplainer (composition)
â”‚   â”‚       â”‚
â”‚   â”‚       â”œâ”€â”€ generate_schedule()
â”‚   â”‚       â”‚   â”œâ”€â”€ _get_current_state()
â”‚   â”‚       â”‚   â”œâ”€â”€ _get_forecasts()
â”‚   â”‚       â”‚   â”œâ”€â”€ optimizer.solve_optimization()
â”‚   â”‚       â”‚   â”œâ”€â”€ _compute_metrics()
â”‚   â”‚       â”‚   â”œâ”€â”€ _generate_explanation() â”€â”€â”€â”€â”€â”€â–º LLM
â”‚   â”‚       â”‚   â””â”€â”€ _convert_to_entries()
â”‚   â”‚       â”‚
â”‚   â”‚       â”œâ”€â”€ _generate_explanation()
â”‚   â”‚       â”‚   â”œâ”€â”€ LLMExplainer.generate_explanation() â”€â”€â–º API
â”‚   â”‚       â”‚   â””â”€â”€ LLMExplainer._generate_fallback_explanation()
â”‚   â”‚       â”‚
â”‚   â”‚       â””â”€â”€ _generate_fallback_schedule()
â”‚   â”‚
â”‚   â”œâ”€â”€ optimizer.py (780 lines)
â”‚   â”‚   â””â”€â”€ MPCOptimizer
â”‚   â”‚       â”œâ”€â”€ PumpSpec (list)
â”‚   â”‚       â”œâ”€â”€ SystemConstraints
â”‚   â”‚       â”‚
â”‚   â”‚       â”œâ”€â”€ solve_optimization()
â”‚   â”‚       â”‚   â”œâ”€â”€ _solve_full_optimization()
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ OR-Tools Solver (SCIP)
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ Dual-Horizon Strategy
â”‚   â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ Strategic (24h)
â”‚   â”‚       â”‚   â”‚   â”‚   â””â”€â”€ Tactical (2h)
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ Variables: pump_on, freq, l1_violations
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ Constraints: bounds, min_on/off, violations
â”‚   â”‚       â”‚   â”‚   â””â”€â”€ Objectives: cost, energy, smoothness, fairness
â”‚   â”‚       â”‚   â”‚
â”‚   â”‚       â”‚   â”œâ”€â”€ _solve_simplified_optimization() [fallback]
â”‚   â”‚       â”‚   â”‚   â””â”€â”€ Simplified constraints
â”‚   â”‚       â”‚   â”‚
â”‚   â”‚       â”‚   â””â”€â”€ _solve_rule_based() [fallback]
â”‚   â”‚       â”‚       â””â”€â”€ Rule-based heuristics
â”‚   â”‚       â”‚
â”‚   â”‚       â”œâ”€â”€ derive_strategic_guidance()
â”‚   â”‚       â”‚   â””â”€â”€ CHEAP / EXPENSIVE / NORMAL periods
â”‚   â”‚       â”‚
â”‚   â”‚       â””â”€â”€ get_adaptive_weights()
â”‚   â”‚           â””â”€â”€ Risk-based objective weighting
â”‚   â”‚
â”‚   â””â”€â”€ explainability.py (170 lines)
â”‚       â””â”€â”€ LLMExplainer
â”‚           â”œâ”€â”€ api_base, api_key, model
â”‚           â”‚
â”‚           â”œâ”€â”€ generate_explanation() [async]
â”‚           â”‚   â”œâ”€â”€ _build_prompt()
â”‚           â”‚   â”œâ”€â”€ httpx.AsyncClient â”€â”€â”€â”€â”€â”€â–º Featherless API
â”‚           â”‚   â””â”€â”€ Response parsing
â”‚           â”‚
â”‚           â””â”€â”€ _generate_fallback_explanation()
â”‚               â””â”€â”€ Rule-based explanation
â”‚
â”œâ”€â”€ ğŸ“Š DATA LAYER
â”‚   â”‚
â”‚   â””â”€â”€ test_data_loader.py (299 lines)
â”‚       â””â”€â”€ HSYDataLoader
â”‚           â”œâ”€â”€ _load_data()
â”‚           â”‚   â””â”€â”€ pandas.read_excel()
â”‚           â”‚
â”‚           â”œâ”€â”€ get_state_at_time()
â”‚           â”‚   â””â”€â”€ CurrentState (l1, inflow, outflow, price)
â”‚           â”‚
â”‚           â”œâ”€â”€ get_forecast_from_time()
â”‚           â”‚   â”œâ”€â”€ ForecastData (perfect/persistence)
â”‚           â”‚   â””â”€â”€ inflow, price forecasts
â”‚           â”‚
â”‚           â”œâ”€â”€ get_baseline_schedule_at_time()
â”‚           â”‚   â””â”€â”€ Historical pump schedules
â”‚           â”‚
â”‚           â””â”€â”€ get_pump_specs_from_data()
â”‚               â””â”€â”€ PumpSpec extraction
â”‚
â”œâ”€â”€ ğŸ§ª TESTING & SIMULATION
â”‚   â”‚
â”‚   â”œâ”€â”€ test_simulator.py (437 lines)
â”‚   â”‚   â””â”€â”€ RollingMPCSimulator
â”‚   â”‚       â”œâ”€â”€ HSYDataLoader (composition)
â”‚   â”‚       â”œâ”€â”€ MPCOptimizer (composition)
â”‚   â”‚       â”œâ”€â”€ LLMExplainer (optional composition)
â”‚   â”‚       â”‚
â”‚   â”‚       â”œâ”€â”€ simulate()
â”‚   â”‚       â”‚   â””â”€â”€ Loop: current_time to end_time
â”‚   â”‚       â”‚       â”œâ”€â”€ Get current state
â”‚   â”‚       â”‚       â”œâ”€â”€ Get forecast
â”‚   â”‚       â”‚       â”œâ”€â”€ optimizer.solve_optimization() â”€â”€â”€â”
â”‚   â”‚       â”‚       â”‚                                      â”‚
â”‚   â”‚       â”‚       â”œâ”€â”€ Generate explanation [if LLM]     â”‚
â”‚   â”‚       â”‚       â”‚   â”œâ”€â”€ derive_strategic_guidance()   â”‚
â”‚   â”‚       â”‚       â”‚   â”œâ”€â”€ _compute_step_metrics()       â”‚
â”‚   â”‚       â”‚       â”‚   â””â”€â”€ llm_explainer.generate_explanation() â”€â”€â–º API
â”‚   â”‚       â”‚       â”‚                                      â”‚
â”‚   â”‚       â”‚       â””â”€â”€ Store SimulationResult            â”‚
â”‚   â”‚       â”‚           â””â”€â”€ explanation, strategy, result â”‚
â”‚   â”‚       â”‚                                           â”‚
â”‚   â”‚       â”œâ”€â”€ compare_with_baseline()                 â”‚
â”‚   â”‚       â”‚   â””â”€â”€ Calculate metrics                   â”‚
â”‚   â”‚       â”‚                                          â”‚
â”‚   â”‚       â””â”€â”€ _compute_step_metrics()                â”‚
â”‚   â”‚           â””â”€â”€ ScheduleMetrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   â”‚
â”‚   â”œâ”€â”€ test_metrics.py (232 lines)
â”‚   â”‚   â””â”€â”€ MetricsCalculator
â”‚   â”‚       â”œâ”€â”€ RollingMPCSimulator (composition)
â”‚   â”‚       â”œâ”€â”€ LLMExplainer (optional composition)
â”‚   â”‚       â”‚
â”‚   â”‚       â””â”€â”€ generate_comparison_report()
â”‚   â”‚           â”œâ”€â”€ Energy metrics (optimized vs baseline)
â”‚   â”‚           â”œâ”€â”€ Cost metrics
â”‚   â”‚           â”œâ”€â”€ Violation metrics
â”‚   â”‚           â”œâ”€â”€ Smoothness metrics
â”‚   â”‚           â”œâ”€â”€ Pump operating hours
â”‚   â”‚           â”œâ”€â”€ Specific energy
â”‚   â”‚           â””â”€â”€ LLM summary explanation [if LLM]
â”‚   â”‚
â”‚   â””â”€â”€ test_optimizer_with_data.py (309 lines)
â”‚       â””â”€â”€ Main Test Script
â”‚           â”œâ”€â”€ Parse arguments
â”‚           â”œâ”€â”€ Load .env file
â”‚           â”œâ”€â”€ HSYDataLoader â”€â”€â”€â”
â”‚           â”œâ”€â”€ Create MPCOptimizer â”‚
â”‚           â”œâ”€â”€ Initialize LLMExplainer [if --use-llm] â”‚
â”‚           â”œâ”€â”€ RollingMPCSimulator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚           â”œâ”€â”€ Run simulation
â”‚           â”œâ”€â”€ MetricsCalculator
â”‚           â””â”€â”€ Generate report
â”‚
â””â”€â”€ âš™ï¸ CONFIGURATION
    â”‚
    â”œâ”€â”€ .env
    â”‚   â”œâ”€â”€ FEATHERLESS_API_BASE
    â”‚   â”œâ”€â”€ FEATHERLESS_API_KEY
    â”‚   â””â”€â”€ LLM_MODEL
    â”‚
    â””â”€â”€ PLAN.md (Implementation guidelines)


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š DATA FLOW
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[Historical Data] 
    â†“
[HSYDataLoader]
    â†“
[CurrentState + ForecastData]
    â†“
[MPCOptimizer.solve_optimization()]
    â†“
    â”œâ”€â†’ [OR-Tools Solver]
    â”‚       â†“
    â”‚   [OptimizationResult]
    â”‚       â†“
    â””â”€â†’ [OptimizationAgent / RollingMPCSimulator]
            â†“
        [Compute Metrics]
            â†“
        [LLMExplainer.generate_explanation()] â”€â”€â”€â–º [Featherless API]
            â†“
        [Explanation Text]
            â†“
        [OptimizationResponse / SimulationResult]


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”„ OPTIMIZATION MODES (Fallback Chain)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Full Optimization
    â”œâ”€â†’ Success â†’ Return Result
    â”‚
    â””â”€â†’ Failure â†’ Simplified Optimization
                      â”œâ”€â†’ Success â†’ Return Result
                      â”‚
                      â””â”€â†’ Failure â†’ Rule-Based
                                        â””â”€â†’ Always Success â†’ Return Result


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ¯ OPTIMIZATION OBJECTIVES (Weighted)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Total Objective = 
    cost_weight Ã— Cost Objective +
    energy_weight Ã— Energy Objective +
    smoothness_weight Ã— Outflow Smoothness +
    fairness_weight Ã— Pump Fairness +
    violation_penalty Ã— L1 Violation Penalty


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ”— EXTERNAL DEPENDENCIES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Python Packages:
    â€¢ ortools (OR-Tools Solver)
    â€¢ numpy, pandas (Data processing)
    â€¢ httpx (HTTP client for LLM API)
    â€¢ python-dotenv (Environment variables)
    â€¢ pydantic (Data validation)

External Services:
    â€¢ Featherless API (LLM explanations)
        â””â”€â†’ meta-llama/Meta-Llama-3.1-8B-Instruct


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ˆ STATISTICS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Total Lines of Code: 2,661 lines
Core Components:     1,384 lines (52%)
Testing/Simulation:  978 lines  (37%)
Data Layer:          299 lines  (11%)


â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

